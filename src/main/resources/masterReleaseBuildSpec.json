{
  "version": 0.2,
  "phases": {
    "install": {
      "runtime-versions": {
        "java": "corretto11",
        "docker": 19
      }
    },
    "pre_build": {
      "commands": [
        "echo Checking installed maven version",
        "mvn -v",
        "echo Logging into AWS ECR...",
        "aws --version",
        "$(aws ecr get-login --region $AWS_DEFAULT_REGION --no-include-email)",
        "COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)",
        "echo $COMMIT_HASH",
        "IMAGE_TAG=${COMMIT_HASH:=latest}",
        "echo $IMAGE_TAG",
        "echo ECR Repository URI",
        "echo $ECR_REPOSITORY_URI"
      ]
    },
    "build": {
      "commands": [
        "echo Build started on `date`",
        "echo Building the Docker image...",
        "docker build -t $ECR_REPOSITORY_URI:latest .",
        "docker tag $ECR_REPOSITORY_URI:latest $ECR_REPOSITORY_URI:$IMAGE_TAG"
      ]
    },
    "post_build": {
      "commands": [
        "echo Build completed on `date`",
        "echo pushing to repo",
        "docker push $ECR_REPOSITORY_URI:latest",
        "docker push $ECR_REPOSITORY_URI:$IMAGE_TAG",
        "echo Writing image definitions file...",
        "printf '{\"ImageURI\":\"%s\"}' $ECR_REPOSITORY_URI:$IMAGE_TAG > imageDefinitions.json"
      ]
    }
  },
  "artifacts": {
    "files": [
      "imageDefinitions.json"
    ]
  }
}